<template>
    <Dialog :open="open" @update:open="(v: boolean) => (!v) && $emit('close')">
        <DialogContent class="!max-w-none !w-[56vw]">
            <DialogHeader>
                <DialogTitle>{{ editing ? 'Editar evento' : 'Novo evento' }}</DialogTitle>
                <DialogDescription>Preencha as abas abaixo e salve.</DialogDescription>
            </DialogHeader>

            <form class="space-y-4" @submit.prevent="onSubmit">
                <Tabs v-model="tab" class="w-full">
                    <TabsList class="w-full justify-start overflow-x-auto">
                         <TabsTrigger value="info">Informações do Evento</TabsTrigger>
                         <TabsTrigger value="talk">Informações da Palestra</TabsTrigger>
                         <TabsTrigger value="sponsors">Patrocinadores</TabsTrigger>
                         <TabsTrigger value="faq">FAQ</TabsTrigger>
                         <TabsTrigger value="messaging">Mensageria</TabsTrigger>
                     </TabsList>

                    <!-- ============ ABA: INFORMAÇÕES DO EVENTO ============ -->
                    <TabsContent value="info" class="mt-6 overflow-y-auto max-h-[450px]">
                        <div class="grid md:grid-cols-2 gap-6">
                            <!-- Coluna ESQUERDA -->
                            <div class="space-y-4">
                                <div>
                                    <Label for="title">Título *</Label>
                                    <Input id="title" v-model="form.title" required />
                                </div>

                                <div>
                                    <Label for="theme">Tema</Label>
                                    <Input id="theme" v-model="form.theme" />
                                </div>

                                <div>
                                    <Label for="type">Tipo</Label>
                                    <Select v-model="form.type">
                                        <SelectTrigger id="type"
                                            class="bg-background border border-input shadow-sm focus:ring-2 focus:ring-ring focus:outline-none">
                                            <SelectValue placeholder="Selecionar" />
                                        </SelectTrigger>
                                        <SelectContent
                                            class="bg-black text-popover-foreground border border-input shadow-lg rounded-md">
                                            <SelectItem value="MEETUP">MEETUP</SelectItem>
                                            <SelectItem value="WORKSHOP">WORKSHOP</SelectItem>
                                            <SelectItem value="TALK">TALK</SelectItem>
                                        </SelectContent>
                                    </Select>
                                </div>

                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <Label for="date">Data</Label>
                                        <Input id="date" type="date" v-model="form.date" />
                                    </div>
                                    <div>
                                        <Label for="time">Hora</Label>
                                        <Input id="time" type="time" v-model="form.time" />
                                    </div>
                                </div>

                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <Label for="dateLabel">Rótulo de data</Label>
                                        <Input id="dateLabel" v-model="form.dateLabel"
                                            placeholder="Ex.: 12 de Outubro" />
                                    </div>
                                    <div>
                                        <Label for="timeLabel">Rótulo de hora</Label>
                                        <Input id="timeLabel" v-model="form.timeLabel" placeholder="Ex.: 19h às 21h" />
                                    </div>
                                </div>

                                <div class="flex items-center gap-2 pt-1">
                                    <Switch id="isCurrent" :model-value="form.isCurrent"
                                        @update:model-value="(val: boolean) => form.isCurrent = val" />
                                    <Label for="isCurrent">Evento atual</Label>
                                </div>

                                <div>
                                    <Label for="banner">Banner</Label>
                                    <Input id="banner" type="file" accept="image/*" @change="onBannerChange" />
                                    <p v-if="editing?.bannerKey" class="text-xs text-muted-foreground mt-1">
                                        Atual: {{ editing.bannerKey }}
                                    </p>
                                </div>
                            </div>

                            <!-- Coluna DIREITA -->
                            <div class="space-y-4">
                                <div>
                                    <Label for="location">Local</Label>
                                    <Input id="location" v-model="form.location" />
                                </div>

                                <div>
                                    <Label for="venueName">Nome do local</Label>
                                    <Input id="venueName" v-model="form.venueName" />
                                </div>

                                <div>
                                    <Label for="venueAddress">Endereço</Label>
                                    <Input id="venueAddress" v-model="form.venueAddress" />
                                </div>

                                <div>
                                    <Label for="venueMapUrl">URL do mapa</Label>
                                    <Input id="venueMapUrl" v-model="form.venueMapUrl" type="url" />
                                </div>

                                <div>
                                    <Label for="description">Descrição</Label>
                                    <Textarea id="description" v-model="form.description" rows="6" />
                                </div>

                                <div>
                                    <Label for="hashtags">Hashtags (separadas por vírgula)</Label>
                                    <Input id="hashtags" v-model="hashtagsInput" placeholder="aws, comunidade, dev" />
                                </div>

                                <!-- Preview do banner -->
                                <div v-if="bannerPreviewUrl" class="mt-2">
                                    <div class="text-xs text-muted-foreground mb-1">Pré-visualização</div>
                                    <img :src="bannerPreviewUrl" alt="Pré-visualização do banner"
                                        class="block w-full max-h-50 object-cover rounded-md border" />
                                </div>
                            </div>
                        </div>
                    </TabsContent>

                    <!-- ============ ABA: INFORMAÇÕES DA PALESTRA ============ -->
                    <TabsContent value="talk" class="mt-6 space-y-6">
                        <!-- Lista de palestras existentes -->
                        <div v-if="existingTalks.length" class="border rounded-xl p-3 space-y-2">
                            <h3 class="text-sm font-medium mb-2">Palestras do evento:</h3>
                            <div v-for="t in existingTalks" :key="t.id" class="border rounded-md p-2 flex items-center justify-between">
                                <div>
                                    <p class="font-medium">{{ t.title }}</p>
                                    <p class="text-sm text-muted-foreground">Palestrante: {{ t.speaker?.name ?? 'Não encontrado' }}</p>
                                </div>
                                <Button size="sm" variant="destructive" type="button" @click="deleteExistingTalk(t.id)">Excluir</Button>
                            </div>
                        </div>

                        <!-- Lista de palestras pendentes -->
                        <div v-if="pendingTalks.length" class="border rounded-xl p-3 space-y-2">
                            <h3 class="text-sm font-medium mb-2">Palestras a serem adicionadas:</h3>
                             <div v-for="t in pendingTalks" :key="t._id" class="border rounded-md p-2 flex items-center justify-between">
                                <div>
                                    <p class="font-medium">{{ t.title }}</p>
                                    <p class="text-sm text-muted-foreground">Palestrante: {{ getSpeakerName(t.speakerId) }}</p>
                                </div>
                                <Button size="sm" variant="ghost" type="button" @click="removePendingTalk(t._id)">Remover</Button>
                            </div>
                        </div>

                        <!-- Formulário para adicionar nova palestra -->
                        <div class="border rounded-xl p-4 space-y-4">
                            <h3 class="text-lg font-semibold">Adicionar Palestra</h3>
                            <div class="grid md:grid-cols-2 gap-6">
                                <div class="space-y-4">
                                    <div>
                                        <Label for="talkTitle">Título da palestra *</Label>
                                        <Input id="talkTitle" v-model="talkForm.title" placeholder="Ex.: Serverless na prática" />
                                    </div>

                                    <div>
                                        <Label for="speaker">Palestrante *</Label>
                                        <Select v-model="talkForm.speakerId">
                                            <SelectTrigger id="speaker">
                                                <SelectValue placeholder="Selecionar palestrante" />
                                            </SelectTrigger>
                                            <SelectContent class="bg-black text-popover-foreground border border-input shadow-lg rounded-md">
                                                <SelectItem v-for="sp in speakerOptions" :key="sp.id" :value="sp.id">
                                                    {{ sp.name }} <span v-if="sp.title" class="text-muted-foreground"> — {{ sp.title }}</span>
                                                </SelectItem>
                                            </SelectContent>
                                        </Select>
                                    </div>

                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <Label for="duration">Duração (min)</Label>
                                            <Input id="duration" type="number" min="0" v-model.number="talkForm.durationMinutes" />
                                        </div>
                                        <div>
                                            <Label for="order">Ordem</Label>
                                            <Input id="order" type="number" min="0" v-model.number="talkForm.order" />
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <Label for="abstract">Resumo / Abstract</Label>
                                    <Textarea id="abstract" rows="8" v-model="talkForm.abstract" placeholder="Descrição breve do conteúdo da palestra" />
                                </div>
                            </div>
                             <Button type="button" @click="addPendingTalk" :disabled="!talkForm.title || !talkForm.speakerId">
                                Adicionar Palestra à Lista
                            </Button>
                        </div>
                    </TabsContent>

                    <!-- ============ ABA: PATROCINADORES ============ -->
                    <TabsContent value="sponsors" class="mt-6 space-y-4">
                        <div class="grid md:grid-cols-3 gap-4">
                            <div class="md:col-span-2 space-y-3">
                                <div>
                                    <Label for="sponsorName">Nome do patrocinador</Label>
                                    <Input id="sponsorName" v-model="sponsorForm.name" placeholder="Ex.: Empresa XYZ" />
                                </div>
                                <div>
                                    <Label for="sponsorLogo">Logo (imagem)</Label>
                                    <Input id="sponsorLogo" type="file" accept="image/*"
                                        @change="onSponsorLogoChange" />
                                </div>
                                <Button type="button" @click="addSponsor" :disabled="!sponsorForm.name">
                                    Adicionar patrocinador à lista
                                </Button>
                            </div>

                            <div v-if="sponsorForm.previewUrl" class="border rounded-lg overflow-hidden">
                                <img :src="sponsorForm.previewUrl" alt="Preview logo"
                                    class="h-40 w-full object-contain bg-muted" />
                            </div>
                        </div>

                        <div v-if="pendingSponsors.length" class="border rounded-xl p-3">
                            <div class="text-sm font-medium mb-2">Patrocinadores a serem criados:</div>
                            <ul class="grid sm:grid-cols-2 lg:grid-cols-3 gap-3">
                                <li v-for="sp in pendingSponsors" :key="sp._id"
                                    class="border rounded-md p-2 flex items-center gap-3">
                                    <img v-if="sp.previewUrl" :src="sp.previewUrl" class="h-10 w-10 object-contain"
                                        alt="" />
                                    <div class="flex-1">
                                        <div class="text-sm font-medium">{{ sp.name }}</div>
                                        <div class="text-xs text-muted-foreground text-ellipsis">{{ sp.logoFile?.name ||
                                            '—'
                                            }}</div>
                                    </div>
                                    <Button size="sm" variant="ghost" type="button"
                                        @click="removeSponsor(sp._id)">Remover</Button>
                                </li>
                            </ul>
                        </div>

                        <div v-if="existingSponsors.length" class="border rounded-xl p-3">
                            <div class="text-sm font-medium mb-2">Patrocinadores atuais:</div>
                            <ul class="grid sm:grid-cols-2 lg:grid-cols-3 gap-3">
                                <li v-for="sp in existingSponsors" :key="sp.id"
                                    class="border rounded-md p-2 flex items-center gap-3">
                                    <img v-if="sp.logoKey" :src="existingLogoUrl(sp.logoKey)"
                                        class="h-10 w-10 object-contain" alt="" />
                                    <div class="text-sm">{{ sp.name }}</div>
                                    <!-- TODO: adicionar botão de remoção -->
                                </li>
                            </ul>
                        </div>
                    </TabsContent>

                    <!-- ============ ABA: FAQ ============ -->
                    <TabsContent value="faq" class="mt-6 space-y-4">
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <Label for="faqQuestion">Pergunta</Label>
                                <Input id="faqQuestion" v-model="faqForm.question"
                                    placeholder="Ex.: Precisa de inscrição?" />
                            </div>
                            <div>
                                <Label for="faqAnswer">Resposta</Label>
                                <Input id="faqAnswer" v-model="faqForm.answer"
                                    placeholder="Ex.: Não, é entrada gratuita." />
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <Button type="button" @click="addPendingFaq"
                                :disabled="!faqForm.question || !faqForm.answer">
                                Adicionar FAQ
                            </Button>
                            <Button type="button" variant="secondary" @click="reloadExistingFaqs"
                                :disabled="!props.editing">
                                Recarregar FAQs existentes
                            </Button>
                        </div>

                        <!-- Pendentes (serão criadas no submit) -->
                        <div v-if="pendingFaqs.length" class="border rounded-xl p-3">
                            <div class="text-sm font-medium mb-2">FAQs a serem criadas:</div>
                            <ul class="space-y-2">
                                <li v-for="f in pendingFaqs" :key="f._id" class="border rounded-md p-2">
                                    <div class="font-medium">{{ f.question }}</div>
                                    <div class="text-sm text-muted-foreground">{{ f.answer }}</div>
                                    <div class="mt-1">
                                        <Button size="sm" variant="ghost" type="button"
                                            @click="removePendingFaq(f._id)">Remover</Button>
                                    </div>
                                </li>
                            </ul>
                        </div>

                        <!-- Existentes (já no banco) -->
                        <div v-if="existingFaqs.length" class="border rounded-xl p-3">
                            <div class="text-sm font-medium mb-2">FAQs atuais:</div>
                            <ul class="space-y-2">
                                <li v-for="f in existingFaqs" :key="f.id" class="border rounded-md p-2">
                                    <div class="font-medium">{{ f.question }}</div>
                                    <div class="text-sm text-muted-foreground">{{ f.answer }}</div>
                                    <!-- opcional: remover direto do backend -->
                                    <div class="mt-1">
                                        <Button size="sm" variant="ghost" type="button"
                                            @click="deleteExistingFaq(f.id)">Excluir</Button>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </TabsContent>

                    <!-- ============ ABA: MENSAGERIA ============ -->
                    <TabsContent value="messaging" class="mt-6 space-y-6">
                        <!-- Lista colapsável de destinatários -->
                        <Accordion type="single" collapsible class="w-full">
                            <AccordionItem value="users">
                                <AccordionTrigger>Destinatários ({{ broadcasts.recipients.length }})</AccordionTrigger>
                                <AccordionContent>
                                    <div v-if="broadcasts.recipients.length" class="space-y-2 max-h-60 overflow-y-auto">
                                        <div v-for="u in broadcasts.recipients" :key="u.username" class="border rounded-md p-2">
                                            <p class="font-medium">{{ u.username }}</p>
                                            <p class="text-sm text-muted-foreground">{{ u.phoneE164 }}</p>
                                        </div>
                                    </div>
                                    <p v-else class="text-muted-foreground">Nenhum destinatário encontrado.</p>
                                </AccordionContent>
                            </AccordionItem>
                        </Accordion>

                        <!-- Formulário para criar broadcast -->
                        <div class="border rounded-xl p-4 space-y-4">
                            <h3 class="text-lg font-semibold">Criar Broadcast</h3>
                            <div class="space-y-4">
                                <div>
                                    <Label for="templateBody">Mensagem (Template Body) *</Label>
                                    <Textarea id="templateBody" v-model="broadcasts.broadcastForm.templateBody" rows="4" placeholder="Digite a mensagem a ser enviada" />
                                </div>

                                <div>
                                    <Label for="kind">Tipo de Agendamento</Label>
                                    <Select v-model="broadcasts.broadcastForm.kind">
                                        <SelectTrigger>
                                            <SelectValue placeholder="Selecionar" />
                                        </SelectTrigger>
                                        <SelectContent
                                            class="bg-black text-popover-foreground border border-input shadow-lg rounded-md">
                                            <SelectItem value="NOW">Agora</SelectItem>
                                            <SelectItem value="AT">Em horário específico</SelectItem>
                                            <SelectItem value="CRON">Horários recorrentes</SelectItem>
                                        </SelectContent>
                                    </Select>
                                </div>

                                <div v-if="broadcasts.broadcastForm.kind === 'AT'">
                                    <Label for="scheduledAtIso">Data e Hora</Label>
                                    <Input id="scheduledAtIso" type="datetime-local" v-model="broadcasts.broadcastForm.scheduledAtIso" />
                                </div>

                                <div v-if="broadcasts.broadcastForm.kind === 'CRON'" class="space-y-2">
                                    <Label>Horários Recorrentes</Label>
                                    <div class="flex gap-2">
                                        <Input type="time" v-model="broadcasts.timeInput" />
                                        <Button type="button" @click="broadcasts.addTime" :disabled="!broadcasts.timeInput">+</Button>
                                    </div>
                                    <div v-if="broadcasts.broadcastForm.cronTimes.length" class="space-y-1">
                                        <p class="text-sm">Horários adicionados:</p>
                                        <div class="flex flex-wrap gap-2">
                                            <span v-for="t in broadcasts.broadcastForm.cronTimes" :key="t" class="bg-muted px-2 py-1 rounded text-sm flex items-center gap-1">
                                                {{ t }}
                                                <Button size="sm" variant="ghost" @click="broadcasts.removeTime(t)">×</Button>
                                            </span>
                                        </div>
                                        <p class="text-xs text-muted-foreground">Cron: {{ broadcasts.cronExpression }}</p>
                                    </div>
                                </div>

                               <Button type="button" @click="broadcasts.addBroadcastToPending" :disabled="!broadcasts.broadcastForm.templateBody">
                                   Adicionar Broadcast à Lista
                               </Button>

                               <Button
                                 v-if="currentEditingId"
                                 type="button"
                                 variant="secondary"
                                 @click="saveEditedBroadcast"
                               >
                                 Salvar edição
                               </Button>
                            </div>
                        </div>

                        <!-- Lista de broadcasts pendentes -->
                        <div v-if="broadcasts.pendingBroadcasts.length" class="border rounded-xl p-3">
                            <div class="text-sm font-medium mb-2">Broadcasts a serem criados:</div>
                            <div class="space-y-2">
                                <div v-for="b in broadcasts.pendingBroadcasts" :key="b._id" class="border rounded-md p-2">
                                    <p class="font-medium">{{ b.templateBody }}</p>
                                    <p class="text-sm text-muted-foreground">Tipo: {{ b.kind }}</p>
                                    <p v-if="b.kind === 'AT'" class="text-sm text-muted-foreground">Agendado: {{ b.scheduledAtIso }}</p>
                                    <p v-if="b.kind === 'CRON'" class="text-sm text-muted-foreground">Cron: {{ b.cron }}</p>
                                    <Button size="sm" variant="ghost" type="button" @click="broadcasts.removePendingBroadcast(b._id)">Remover</Button>
                                </div>
                            </div>
                        </div>

                        <!-- Broadcasts atuais -->
                        <div v-if="props.editing && broadcasts.items.length" class="border rounded-xl p-3 mt-6">
                            <div class="text-sm font-medium mb-2">Broadcasts atuais:</div>
                            <div class="space-y-2">
                                <div v-for="b in broadcasts.items" :key="b.id" class="border rounded-md p-2">
                                    <div class="flex items-start justify-between gap-4">
                                        <div class="space-y-1">
                                            <p class="font-medium whitespace-pre-wrap">{{ b.templateBody }}</p>
                                            <p class="text-xs text-muted-foreground">
                                                Tipo: {{ b.scheduleKind || '—' }}
                                                <span v-if="b.scheduleKind === 'AT'"> • {{ b.scheduledAtIso }}</span>
                                                <span v-if="b.scheduleKind === 'CRON'"> • {{ b.cron }}</span>
                                                • Status: <span class="font-medium">{{ b.status || '—' }}</span>
                                            </p>
                                        </div>
                                        <div class="flex gap-2">
                                            <Button size="sm" variant="secondary" @click="() => onEditBroadcast(b)">Editar</Button>
                                            <Button size="sm" variant="destructive" @click="() => onDeleteBroadcast(b.id)">Excluir</Button>
                                            <Button size="sm" @click="() => onStartNow(b.id)" :disabled="b.status === 'running'">Enviar agora</Button>
                                            <Button size="sm" variant="outline" @click="() => onSchedule(b.id)" :disabled="b.scheduleKind === 'NOW'">Agendar</Button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </TabsContent>
                </Tabs>

                <DialogFooter>
                    <Button type="button" variant="secondary" @click="$emit('close')">Cancelar</Button>
                    <Button type="submit" :disabled="submitting">
                        {{ submitting ? 'Salvando…' : 'Salvar' }}
                    </Button>
                </DialogFooter>
            </form>
        </DialogContent>
    </Dialog>
</template>

<script setup lang="ts">
import { computed, reactive, ref, watch, onBeforeUnmount, onMounted } from 'vue'
import { useEvents, type TalkRow } from '@/composables/useEvents'
import { useSpeakers } from '@/composables/useSpeakers'
import { useBroadcasts } from '@/composables/useBroadcasts'
import { getDataClient } from '@/composables/useData'
import { uploadData } from 'aws-amplify/storage'
import { Button } from '@/components/ui/button'
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogFooter } from '@/components/ui/dialog'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Select, SelectTrigger, SelectValue, SelectContent, SelectItem } from '@/components/ui/select'
import { Textarea } from '@/components/ui/textarea'
import { Switch } from '@/components/ui/switch'
import { Tabs, TabsList, TabsTrigger, TabsContent } from '@/components/ui/tabs'
import { Accordion, AccordionContent, AccordionItem, AccordionTrigger } from '@/components/ui/accordion'
import { buildSponsorLogoPath } from '@/constants/storage'

type EventsHook = ReturnType<typeof useEvents>
type SpeakersHook = ReturnType<typeof useSpeakers>

const events: EventsHook = useEvents({ mode: 'private' })
const speakersHook: SpeakersHook = useSpeakers({ mode: 'private' })
const broadcasts = useBroadcasts()
const client = getDataClient('private')

type EventRow = typeof events.items.value[number]
type SpeakerRow = typeof speakersHook.items.value[number]
type CreateInput = Parameters<EventsHook['createEvent']>[0]
type UpdateInput = Parameters<EventsHook['updateEvent']>[0]

type ExistingFaq = { id: string; question: string; answer: string }
type PendingFaq = { _id: string; question: string; answer: string }
type ExistingSponsor = { id: string; name: string; logoKey?: string | null }
type PendingSponsor = { _id: string; name: string; logoFile?: File | null; previewUrl?: string | null }
type ExistingTalk = TalkRow & { speaker?: SpeakerRow }
type PendingTalk = { _id: string; title: string; abstract?: string; durationMinutes?: number; order?: number; speakerId: string }


const props = defineProps<{ open: boolean; editing: EventRow | null }>()
const emit = defineEmits<{ (e: 'close'): void; (e: 'saved', payload: EventRow): void }>()

/* ---------------- UI/Tabs ---------------- */
const tab = ref<'info' | 'talk' | 'sponsors' | 'faq' | 'messaging'>('info')

/* ---------------- Evento (form base) ---------------- */
const form = reactive<CreateInput>({
    title: '', theme: '', type: undefined,
    date: '', time: '',
    dateLabel: '', timeLabel: '',
    location: '', description: '',
    hashtags: [], bannerKey: '', isCurrent: false,
    venueName: '', venueAddress: '', venueMapUrl: '',
})

const hashtagsInput = computed({
    get: () => (form.hashtags ?? []).join(', '),
    set: (v: string) => { form.hashtags = v.split(',').map(s => s.trim()).filter(Boolean) }
})

/* ---------------- Talks ---------------- */
const existingTalks = ref<ExistingTalk[]>([])
const pendingTalks = ref<PendingTalk[]>([])
const talkForm = reactive<Omit<PendingTalk, '_id'>>({
    title: '',
    abstract: '',
    durationMinutes: 60,
    order: 1,
    speakerId: '',
})

/* ---------------- Sponsors ---------------- */
const existingSponsors = ref<ExistingSponsor[]>([])
const sponsorForm = reactive<PendingSponsor>({ _id: '', name: '', logoFile: null, previewUrl: null })
const pendingSponsors = ref<PendingSponsor[]>([])

/* ---------------- FAQ ---------------- */
const existingFaqs = ref<ExistingFaq[]>([])
const pendingFaqs = ref<PendingFaq[]>([])
const faqForm = reactive<PendingFaq>({ _id: '', question: '', answer: '' })

/* ---------------- Helpers de preview ---------------- */
const submitting = ref(false)
const bannerFile = ref<File | null>(null)
const bannerPreviewUrl = ref<string | null>(null)
let bannerObjectUrl: string | null = null

const speakerOptions = computed(() => speakersHook.items.value)

const logoUrlMap = ref<Record<string, string>>({})
function existingLogoUrl(key?: string | null) {
    if (!key) return ''
    const cached = logoUrlMap.value[key]
    if (cached) return cached
    void events.getAssetUrl(key).then(url => {
        if (url) logoUrlMap.value = { ...logoUrlMap.value, [key]: url }
    })
    return ''
}

/* ---------------- Hidratação das relações (Talk/Sponsors/FAQ) ---------------- */
async function hydrateRelations(eventId: string): Promise<void> {
    // Talks
    const talkRes = await client.models.Talk.list({ filter: { eventId: { eq: eventId } }, limit: 100 })
    const talksArr = (talkRes.data ?? []) as TalkRow[]
    const populatedTalks = await Promise.all(
        talksArr.map(async (t: TalkRow) => {
            const speaker = t.speakerId ? await speakersHook.getSpeaker(t.speakerId) : undefined
            return { ...t, speaker: speaker || undefined }
        })
    )
    existingTalks.value = populatedTalks

    // Sponsors existentes
    const spRes = await client.models.EventSponsor.list({ filter: { eventId: { eq: eventId } }, limit: 100 })
    const sponsorsArr = Array.isArray(spRes.data) ? spRes.data : []
    existingSponsors.value = sponsorsArr.map(s => ({ id: s.id, name: s.name, logoKey: s.logoKey ?? null }))

    // FAQs existentes
    await reloadExistingFaqs(eventId)

    // Broadcasts
    await broadcasts.listByEvent(eventId)
    await broadcasts.loadRecipients()
}

/* ---------------- Talk helpers ---------------- */
function addPendingTalk() {
    if (!talkForm.title || !talkForm.speakerId) return
    pendingTalks.value.push({ ...talkForm, _id: crypto.randomUUID() })
    // Reset form
    talkForm.title = ''
    talkForm.abstract = ''
    talkForm.durationMinutes = 60
    talkForm.order = (pendingTalks.value.length + existingTalks.value.length) + 1
    talkForm.speakerId = ''
}
function removePendingTalk(id: string) {
    pendingTalks.value = pendingTalks.value.filter(t => t._id !== id)
}
async function deleteExistingTalk(id: string) {
    await client.models.Talk.delete({ id }, { authMode: 'userPool' })
    existingTalks.value = existingTalks.value.filter(t => t.id !== id)
}
function getSpeakerName(speakerId: string) {
    return speakerOptions.value.find(s => s.id === speakerId)?.name ?? '?'
}

/* ---------------- FAQ helpers ---------------- */
async function reloadExistingFaqs(eventId?: string) {
    const id = eventId ?? props.editing?.id
    if (!id) { existingFaqs.value = []; return }
    const { data, errors } = await client.models.EventFaq.list({
        filter: { eventId: { eq: id } },
        limit: 1000,
        selectionSet: ['id', 'question', 'answer'] as const,
    })
    if (errors?.length) throw new Error(errors.map(e => (e as { message?: string }).message ?? String(e)).join('; '))
    existingFaqs.value = (data ?? []).map(f => ({
        id: f.id, question: f.question ?? '', answer: f.answer ?? ''
    }))
}

function addPendingFaq() {
    if (!faqForm.question.trim() || !faqForm.answer.trim()) return
    const _id = crypto.randomUUID()
    pendingFaqs.value.push({ _id, question: faqForm.question.trim(), answer: faqForm.answer.trim() })
    faqForm._id = ''; faqForm.question = ''; faqForm.answer = ''
}

function removePendingFaq(id: string) {
    pendingFaqs.value = pendingFaqs.value.filter(f => f._id !== id)
}

async function deleteExistingFaq(id: string) {
    await client.models.EventFaq.delete({ id }, { authMode: 'userPool' })
    existingFaqs.value = existingFaqs.value.filter(f => f.id !== id)
}

/* ---------------- Sponsors helpers ---------------- */
function onSponsorLogoChange(ev: Event) {
    const input = ev.target as HTMLInputElement
    const file = input.files?.[0] ?? null
    sponsorForm.logoFile = file
    if (sponsorForm.previewUrl) URL.revokeObjectURL(sponsorForm.previewUrl)
    sponsorForm.previewUrl = file ? URL.createObjectURL(file) : null
}

function addSponsor() {
    if (!sponsorForm.name.trim()) return
    const _id = crypto.randomUUID()
    pendingSponsors.value.push({
        _id,
        name: sponsorForm.name.trim(),
        logoFile: sponsorForm.logoFile ?? undefined,
        previewUrl: sponsorForm.previewUrl ?? undefined, // NÃO revoga aqui
    })
    sponsorForm._id = ''
    sponsorForm.name = ''
    sponsorForm.logoFile = null
    sponsorForm.previewUrl = null
}

function removeSponsor(id: string) {
    const sp = pendingSponsors.value.find(s => s._id === id)
    if (sp?.previewUrl) URL.revokeObjectURL(sp.previewUrl)
    pendingSponsors.value = pendingSponsors.value.filter(s => s._id !== id)
}

/* ---------------- Banner preview ---------------- */
async function computeBannerPreview() {
    if (bannerObjectUrl) { URL.revokeObjectURL(bannerObjectUrl); bannerObjectUrl = null }
    if (bannerFile.value) {
        bannerObjectUrl = URL.createObjectURL(bannerFile.value)
        bannerPreviewUrl.value = bannerObjectUrl
        return
    }
    if (props.editing?.bannerKey) {
        try { bannerPreviewUrl.value = await events.getAssetUrl(props.editing.bannerKey) }
        catch { bannerPreviewUrl.value = null }
        return
    }
    bannerPreviewUrl.value = null
}
function onBannerChange(ev: Event) {
    const input = ev.target as HTMLInputElement
    bannerFile.value = input.files?.[0] ?? null
}
watch([bannerFile, () => props.editing?.bannerKey], () => { void computeBannerPreview() }, { immediate: true })

/* ---------------- Hidratação “ao abrir” ---------------- */
function resetAuxTabs() {
    // talks
    existingTalks.value = []
    pendingTalks.value = []
    talkForm.title = ''
    talkForm.abstract = ''
    talkForm.durationMinutes = 60
    talkForm.order = 1
    talkForm.speakerId = ''

    // sponsors pendentes
    for (const sp of pendingSponsors.value) if (sp.previewUrl) URL.revokeObjectURL(sp.previewUrl)
    pendingSponsors.value = []
    sponsorForm._id = ''; sponsorForm.name = ''; sponsorForm.logoFile = null
    if (sponsorForm.previewUrl) { URL.revokeObjectURL(sponsorForm.previewUrl); sponsorForm.previewUrl = null }

    // faqs pendentes
    pendingFaqs.value = []
}

function initFormFromEditing(e: EventRow) {
    const patch: UpdateInput = {
        id: e.id,
        title: e.title, theme: e.theme, type: e.type,
        date: e.date, time: e.time,
        dateLabel: e.dateLabel, timeLabel: e.timeLabel,
        location: e.location, description: e.description,
        hashtags: e.hashtags ?? [],
        bannerKey: e.bannerKey ?? '',
        isCurrent: e.isCurrent ?? false,
        venueName: e.venueName ?? '', venueAddress: e.venueAddress ?? '', venueMapUrl: e.venueMapUrl ?? '',
    }
    Object.assign(form, patch)
}

async function hydrateOnOpen() {
    tab.value = 'info'

    if (!props.open) return

    // novo evento
    if (!props.editing) {
        Object.assign(form, {
            title: '', theme: '', type: undefined, date: '', time: '',
            dateLabel: '', timeLabel: '', location: '', description: '',
            hashtags: [], bannerKey: '', isCurrent: false,
            venueName: '', venueAddress: '', venueMapUrl: '',
        } as CreateInput)
        existingSponsors.value = []
        existingFaqs.value = []
        resetAuxTabs()
        await computeBannerPreview()
        return
    }

    // edição
    initFormFromEditing(props.editing)
    resetAuxTabs()
    await Promise.all([
        hydrateRelations(props.editing.id),
        computeBannerPreview(),
    ])
}

// roda sempre que o modal abre/fecha e quando o id de edição muda (com modal aberto)
watch(() => props.open, () => { void hydrateOnOpen() }, { immediate: true })
watch(() => props.editing?.id, () => { if (props.open) void hydrateOnOpen() })

/* ---------------- Boot ---------------- */
onMounted(async () => {
    if (speakersHook.items.value.length === 0) {
        await speakersHook.listSpeakers({ limit: 100 })
    }
    await broadcasts.loadRecipients()
})

/* ---------------- Unmount cleanup ---------------- */
onBeforeUnmount(() => {
    if (bannerObjectUrl) URL.revokeObjectURL(bannerObjectUrl)
    for (const sp of pendingSponsors.value) {
        if (sp.previewUrl) URL.revokeObjectURL(sp.previewUrl)
    }
    if (sponsorForm.previewUrl) URL.revokeObjectURL(sponsorForm.previewUrl)
})

/* ---------------- Broadcast handlers ---------------- */
async function onStartNow(id: string) {
  await broadcasts.startNow(id)
}

async function onSchedule(id: string) {
  await broadcasts.schedule(id)
}

async function onDeleteBroadcast(id: string) {
  await broadcasts.remove(id)
  if (props.editing) await broadcasts.listByEvent(props.editing.id)
}

function onEditBroadcast(b: { id: string; templateBody: string; scheduleKind?: any; scheduledAtIso?: string | null; cron?: string | null }) {
  broadcasts.broadcastForm.templateBody = b.templateBody
  broadcasts.broadcastForm.kind = (b.scheduleKind ?? 'NOW') as any
  broadcasts.broadcastForm.scheduledAtIso = b.scheduledAtIso ?? ''
  broadcasts.broadcastForm.cronTimes = []
  broadcasts.timeInput = '' as any
  currentEditingId.value = b.id
}

const currentEditingId = ref<string | null>(null)

async function saveEditedBroadcast() {
  if (!currentEditingId.value) return
  const patch = {
    templateBody: broadcasts.broadcastForm.templateBody,
    scheduleKind: broadcasts.broadcastForm.kind,
    scheduledAtIso: broadcasts.broadcastForm.kind === 'AT' ? broadcasts.broadcastForm.scheduledAtIso : undefined,
    cron: broadcasts.broadcastForm.kind === 'CRON' ? broadcasts.cronExpression.value : undefined
  }
  await broadcasts.update(currentEditingId.value, patch)
  if (props.editing) await broadcasts.listByEvent(props.editing.id)
  currentEditingId.value = null
  broadcasts.broadcastForm.templateBody = ''
  broadcasts.broadcastForm.kind = 'NOW'
  broadcasts.broadcastForm.scheduledAtIso = ''
  broadcasts.broadcastForm.cronTimes = []
}

/* ---------------- Submit ---------------- */
async function onSubmit() {
    try {
        submitting.value = true

        let saved: EventRow
        if (props.editing) {
            saved = await events.updateEvent({ ...(form as UpdateInput), id: props.editing.id })
        } else {
            saved = await events.createEvent(form as CreateInput)
        }

        // banner
        if (bannerFile.value) {
            await events.uploadBanner(bannerFile.value, saved.id)
        }

        // talks pendentes
        for (const talk of pendingTalks.value) {
            await client.models.Talk.create({
                eventId: saved.id,
                title: talk.title,
                abstract: talk.abstract || undefined,
                durationMinutes: talk.durationMinutes ?? undefined,
                order: talk.order ?? undefined,
                speakerId: talk.speakerId,
            }, { authMode: 'userPool' })
        }

        // sponsors pendentes
        for (const sp of pendingSponsors.value) {
            let logoKey: string | undefined
            if (sp.logoFile) {
                const path = buildSponsorLogoPath(saved.id, sp.logoFile.name)
                await uploadData({ path, data: sp.logoFile, options: { contentType: sp.logoFile.type || 'image/*' } }).result
                logoKey = path
            }
            await client.models.EventSponsor.create({ name: sp.name, eventId: saved.id, logoKey }, { authMode: 'userPool' })
        }

        // faqs pendentes
        for (const f of pendingFaqs.value) {
            await client.models.EventFaq.create({ eventId: saved.id, question: f.question, answer: f.answer }, { authMode: 'userPool' })
        }

        // broadcasts pendentes
        await broadcasts.submitBroadcasts(saved.id, broadcasts.pendingBroadcasts.value)

        emit('saved', saved)
    } finally {
        submitting.value = false
    }
}
</script>
